# Технический план разработки (детализированный)
## Проект: "Хроники Вечной Войны"

---

### Введение

Этот документ описывает поэтапный план разработки проекта "Хроники Вечной Войны". Этапы выстроены в логическом порядке, от создания фундаментальных механик к добавлению более сложных систем и контента. Каждый этап содержит детализированные задачи и шаги по контролю качества для обеспечения ясного и последовательного процесса разработки.

---

### Этап 1: Ядро и архитектура

**Цель:** Создать базовую структуру проекта и заложить основу для всех будущих механик.

1.  **Настройка проекта:** `[ВЫПОЛНЕНО]`
    *   Создание структуры папок: `src/` (с подпапками `core`, `ai`, `ui`, `game_objects`), `tests/`.
    *   Инициализация репозитория `git`.
    *   Создание файла `main.py` - точки входа в приложение.
2.  **Движок игры:** `[ВЫПОЛНЕНО]`
    *   В `main.py`: инициализация `Pygame`.
    *   Создание класса `Game` в `src/core/game.py`, отвечающего за главный игровой цикл (main loop).
    *   Реализация обработки базовых событий (выход из игры).
3.  **Управление временем и календарь:** `[ОСНОВА ЗАЛОЖЕНА]`
    *   В классе `Game`: внедрение `pygame.time.Clock` для контроля FPS.
    *   Создание в `Game` переменных-заглушек для паузы и ускорения времени (`paused`, `time_multiplier`).
    *   Создание в `GameWorld` переменной-заглушки для отслеживания времени (`current_time`).
4.  **Базовые классы:** `[ВЫПОЛНЕНО]`
    *   `src/game_objects/unit.py`: `Unit` (атрибуты: `hp`, `attack`, `defense`).
    *   `src/game_objects/army.py`: `Army` (атрибуты: список `units`, `position`).
    *   `src/game_objects/faction.py`: `Faction` (атрибуты: список `armies`, `color`, `name`).
    *   `src/core/world.py`: `GameWorld` (атрибуты: `map_data`, список `factions`, `current_time`).
5.  **Система рендеринга:** `[ВЫПОЛНЕНО]`
    *   В `src/core/renderer.py`: класс `Renderer` с методом `render(world, screen)`, который пока ничего не отрисовывает, но вызывается в главном цикле.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что игровой цикл стабилен, время ускоряется/замедляется и ставится на паузу корректно, а внутриигровой календарь правильно считает дни и сезоны.
*   **Документация:** Написать докстринги для базовых классов (`Game`, `GameWorld`, `Army` и т.д.).

**Результат этапа:** Чёрный экран, работающий игровой цикл, управление временем через консоль/клавиши. В памяти создаются и существуют базовые объекты игры и система календаря.

---

### Этап 2: Мир и карта `[ЗАВЕРШЕН]`

**Цель:** Сделать мир видимым и интерактивным.

1.  **Процедурная генерация карты:** `[ВЫПОЛНЕНО]`
    *   В `src/core/map_generator.py`: функция `generate_map(width, height)`, использующая, например, шум Перлина для создания 2D-массива тайлов.
    *   Определение базовых типов тайлов: `GRASS`, `WATER`, `MOUNTAIN`, `FOREST`.
2.  **Визуализация карты:** `[ВЫПОЛНЕНО]`
    *   В `Renderer`: метод `render_map(map_data, screen)` для отрисовки тайлов.
    *   Отрисовка тайлов цветными прямоугольниками, генерируемыми, в зависимости от типа ландшафта.
3.  **Камера:** `[ВЫПОЛНЕНО]`
    *   В `src/core/camera.py`: класс `Camera` с атрибутами `x`, `y`, `zoom`.
    *   Реализация методов `move(dx, dy)` и `zoom_in/out()`.
    *   Интеграция камеры в `Renderer` для отрисовки только видимой части карты.

**Сопутствующие задачи:**
*   **Тестирование:** `[ВЫПОЛНЕНО]` Проверить, что камера плавно движется и масштабируется, не выходит за границы карты.
*   **Документация:** `[ВЫПОЛНЕНО]` Написать докстринги для класса `Camera`.

**Результат этапа:** Отображается игровая карта, которую можно исследовать с помощью перемещения и масштабирования камеры. Производительность стабильна.

---

### Этап 3: Базовые механики армий и юнитов `[ЗАВЕРШЕН]`

**Цель:** "Оживить" карту, добавив на неё движущиеся объекты.

1.  **Рендеринг армий:** `[ВЫПОЛНЕНО]`
    *   В `Renderer`: метод `render_armies(armies, screen, camera)`, отображающий армии в виде цветных кругов на их координатах.
2.  **Перемещение:** `[ВЫПОЛНЕНО]`
    *   Интеграция библиотеки для поиска пути, например, `pathfinding`. `[ОТЛОЖЕНО]` - реализовано прямолинейное движение.
    *   В классе `Army`: метод `set_destination(x, y)`, который рассчитывает путь и сохраняет его. `[ВЫПОЛНЕНО]`
    *   В главном цикле: обновление позиций армий вдоль рассчитанного пути с учётом `time_multiplier`. `[ВЫПОЛНЕНО]`
3.  **Управление для тестов:** `[ВЫПОЛНЕНО]`
    *   Реализация обработки кликов мыши для выбора армии и задания ей точки назначения.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить корректность работы pathfinding-а на разных ландшафтах, убедиться, что армии следуют приказам и не проходят сквозь непроходимые тайлы. `[ОТЛОЖЕНО]`
*   **Временная графика:** Создать простые иконки или спрайты для армий разных фракций, чтобы их можно было различать.

**Результат этапа:** Реализована возможность кликать по армиям и задавать им цель, после чего они плавно перемещаются по карте к указанной точке.

---

### Этап 4: Базовая боевая система `[ЗАВЕРШЕН]`

**Цель:** Реализовать ключевой элемент игры — столкновение армий.

1.  **Обнаружение столкновений:** `[ВЫПОЛНЕНО]`
    *   В главном цикле: проверка расстояний между армиями враждующих фракций.
    *   При сближении на определённое расстояние — запуск боя.
2.  **Расчёт боя:** `[ВЫПОЛНЕНО]`
    *   **Рефакторинг:** Устаревшая функция `resolve_combat` заменена на класс `Combat`, который управляет пошаговым боем. Бой теперь представляет собой процесс, а не мгновенный расчет.
3.  **Визуализация и логи:** `[ВЫПОЛНЕНО]`
    *   После боя проигравшая армия удаляется из списка фракции.
    *   В консоль выводится структурированный и подробный лог боя по раундам.

**Сопутствующие задачи:**
*   **Тестирование:** Запустить несколько тестовых боев с разными составами армий, проверить корректность расчётов и удаления проигравшего. `[ВЫПОЛНЕНО]`
*   **Документация:** Описать класс `Combat` и формат данных, которые он возвращает. `[ВЫПОЛНЕНО]`

**Результат этапа:** Армии могут сражаться в тактическом, пошаговом режиме. Система боя стала динамической и менее предсказуемой. Появляется первая версия игрового цикла "перемещение -> бой".

---

### Этап 5: Начальный ИИ-генерал [ЗАВЕРШЕН]

**Цель:** Сделать мир автономным, передав управление армиями ИИ.

1.  **Архитектура ИИ:** `[ВЫПОЛНЕНО]`
    *   Создание папки `src/ai/profiles`.
    *   Создание базовых профилей `aggressive_general.json` и `base_knowledge.json`.
    *   Класс `GeneralAI` в `src/ai/general_ai.py` с логикой загрузки своего профиля.
2.  **Простейшая логика:** `[ВЫПОЛНЕНО]`
    *   Внутри `update`: ИИ находит ближайшую вражескую армию и отдает приказ на атаку, основываясь на параметре `aggression` из своего профиля.
    *   **Уточнение:** "Директивы" ИИ (например, атаковать) являются частью его внутренней логики и не приходят извне.
3.  **Интеграция:** `[ВЫПОЛНЕНО]`
    *   Привязка экземпляров `GeneralAI` к каждой армии при ее создании.
    *   В главном цикле: вызов метода `update` для каждого ИИ-генерала.
    *   Отключение ручного управления армиями.
4.  **Концепция этапа:** `[ВЫПОЛНЕНО]`
    *   На данном этапе мир является "закрытой песочницей". Новые юниты и армии **не создаются**. Цель — научить ИИ управлять имеющимися силами.
    *   Боевая система оперирует конкретными юнитами внутри армий-контейнеров. Потери безвозвратны в рамках текущей сессии.

**Сопутствующие задачи:**
*   **Тестирование:** Наблюдать за поведением ИИ в течение длительного времени, убедиться, что он не зависает, не создаёт "пробок" из армий и принимает базовые решения. `[ВЫПОЛНЕНО]`
*   **Рефакторинг:** Отделить логику ИИ от основного игрового цикла, чтобы их можно было развивать независимо. `[ВЫПОЛНЕНО]`

**Результат этапа:** Игра может "играть сама в себя". Армии под управлением ИИ перемещаются по карте и сражаются друг с другом. Тестовое управление от игрока отключено.

---

### Этап 6: Расширение мира и разнообразия

**Цель:** Добавить тактическую глубину в существующие механики.

1.  **Подтипы ландшафтов и юнитов:**
    *   Расширение классов `Tile` и `Unit` для поддержки всех подтипов и их характеристик (бонусы/штрафы к скорости, атаке, защите).
    *   Обновление генератора карт для создания более разнообразного мира, включая городские территории (деревни, замки и т.д.) как **одиночные тайлы** с особыми свойствами.
2.  **Владение территориями:**
    *   При генерации карта делится на регионы, которые изначально присваиваются фракциям. Каждый тайл на карте имеет своего "владельца".
3.  **Усложнение боевой системы:**
    *   Переработка `resolve_combat`: теперь она должна учитывать бонусы от ландшафта (например, бонус к защите при сражении на "городском" тайле) и систему контр-юнитов.

**Сопутствующие задачи:**
*   **Тестирование:** Провести тесты боевой системы с учётом всех новых юнитов и ландшафтов, проверить все бонусы и штрафы.
*   **Балансировка:** Сделать первую грубую настройку характеристик юнитов, чтобы не было явных имбалансных стратегий.

**Результат этапа:** Бои становятся более тактическими. Победа зависит от правильного использования местности и состава армии.

---

### Этап 7: Базовое производство и пополнение

**Цель:** Создать замкнутый игровой цикл, в котором фракции могут восстанавливать потери и создавать новые армии, делая мир динамичным.

1.  **Экономика-заглушка:**
    *   Добавление городским территориям свойства генерировать условные "очки производства" каждый игровой день.
    *   Добавление в класс `Faction` атрибута для хранения накопленных очков.
2.  **Механика найма:**
    *   Реализация в классе `Faction` метода `recruit_units`.
    *   **Уточнение:** Разные типы юнитов имеют **разную стоимость** в очках производства.
3.  **Логика ИИ для пополнения:**
    *   В `GeneralAI`: добавление простейшей логики. Если армия понесла потери, она получает команду двигаться к ближайшему дружественному городу для пополнения.
    *   **Уточнение:** ИИ стремится **восстановить свой первоначальный состав армии**, нанимая тех юнитов, которых он потерял.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что фракции корректно накапливают ресурсы и нанимают юнитов, а ИИ-генералы правильно принимают решение отступить для пополнения.
*   **Балансировка:** Настроить стоимость юнитов и скорость генерации очков, чтобы мир не стагнировал и не был переполнен армиями.

**Результат этапа:** Игровой мир становится живым. Армии не только сражаются, но и отступают, пополняются и формируются заново, что создает основу для долгосрочной стратегической игры.

---

### Этап 8: Обучение и принятие решений ИИ

**Цель:** Сделать ИИ "умным" и обучаемым.

1.  **База знаний и история:**
    *   В `GeneralAI`: расширение `knowledge_base` (словарь для хранения фактов) и `decision_history`.
    *   **Событийная память:** После боя ИИ запоминает, кто его победил и при каких обстоятельствах, формируя "обиды".
2.  **Система обучения:**
    *   Создание системы весов для тактик (`tactical_matrix` в JSON-профиле).
    *   После боя — вызов функции `learn_from_battle`, которая корректирует веса в профиле и **сохраняет JSON-файл на диск**.
3.  **Контекстное принятие решений:**
    *   `update` ИИ теперь анализирует не только врагов, но и ландшафт, состав армии, свои черты характера (`Traits`) и выбирает тактику с наивысшим весом для текущей ситуации.
    *   Реализация системы **качественных черт характера** (`"Храбрец"`, `"Трус"`), влияющих на выбор тактик.

**Сопутствующие задачи:**
*   **Тестирование:** Создать тестовые сценарии, чтобы проверить, меняется ли поведение ИИ после серии побед/поражений.
*   **Логирование:** Улучшить логирование, чтобы видеть, *почему* ИИ принял то или иное решение.

**Результат этапа:** ИИ-генералы начинают вести себя по-разному, адаптироваться к результатам прошлых боёв и использовать доступные им механики пополнения.

---

### Этап 9: Тактическое управление (Система отрядов)

**Цель:** Дать ИИ-генералам возможность разделять свои армии на более мелкие тактические единицы (отряды) для выполнения специализированных задач, что станет практическим проявлением их "интеллекта".

1.  **Рефакторинг архитектуры:**
    *   Создание класса `Detachment` (Отряд), который становится основной движущейся единицей на карте.
    *   Изменение класса `Army`, который теперь выступает как организационная структура, управляющая своими отрядами.
    *   **Усложнение боевой системы:** Модернизация `resolve_combat`. Простой суммарный расчет заменяется на **тактическую симуляцию**, учитывающую позиционирование (авангард, фланги) и взаимодействие между отдельными отрядами.
2.  **Иерархия командования:**
    *   **Правило:** Решения о найме юнитов принимает только `GeneralAI` на уровне `Army`. Отряд (`Detachment`) **не может** сам нанимать юнитов.
    *   Генерал может приказать отряду транспортировать уже нанятых юнитов из города в основную армию.
3.  **Логика ИИ для управления отрядами:**
    *   Реализация базовых сценариев: создание разведывательных отрядов, авангарда, разделение сил для атаки с разных направлений.
    *   Интеграция с системой обучения: генерал учится, какие тактики с использованием отрядов приносят успех.
4.  **Обратная связь для игрока:**
    *   Визуальное отображение отрядов на карте.
    *   Добавление информации об отрядах в отчеты генерала.
    *   Возможность для игрока давать советы по управлению отрядами через NLP-интерфейс.

**Сопутствующие задачи:**
*   **Тестирование:** Создать сценарии, где разделение сил дает явное преимущество, и проверить, сможет ли ИИ это использовать.
*   **Визуализация:** Разработать понятное отображение связи между армией-контейнером и её отрядами.

**Результат этапа:** ИИ-генералы действуют более реалистично и тактически гибко. Игрок может наблюдать за их решениями и влиять на них, что углубляет геймплей.

---

### Этап 10: Механики игрока-"бога"

**Цель:** Реализовать основной геймплей со стороны игрока.

1.  **Погода и катастрофы:**
    *   Создание системы погоды (`WeatherSystem`), которая меняет глобальные модификаторы.
    *   Реализация UI-кнопок для игрока, чтобы вызывать дождь, туман и т.д.
2.  **NLP-модуль:**
    *   Интеграция `spaCy`. Создание функции `parse_player_message(text)`, которая извлекает сущности.
    *   Метод `inject_information` у `GeneralAI` для добавления этих фактов в `knowledge_base`.
    *   **Система "обиды на игрока":** Если советы игрока приводят к плохим результатам, ИИ может начать их игнорировать.
3.  **Интерфейс взаимодействия:**
    *   Создание текстового поля для ввода сообщений, UI для допроса генерала (вызывает его метод `generate_report`).
    *   Реализация обратной связи, показывающей, как ИИ интерпретировал команду игрока.
4.  **Отладочный UI:**
    *   Создание простого технического UI для разработчика, который наглядно показывает работу NLP-модуля: `исходный текст -> извлеченные сущности -> факт в базе знаний ИИ`. Это необходимо для эффективной отладки.

**Сопутствующие задачи:**
*   **Тестирование:** Протестировать все способы влияния игрока: погода, катастрофы, ввод текста. Проверить, что ИИ корректно реагирует на полученную информацию с помощью отладочного UI.
*   **Документация:** Описать API для NLP-модуля и системы событий, чтобы их было легко расширять.

**Результат этапа:** Реализована возможность для игрока активно влиять на мир и поведение ИИ.

---

### Этап 11: Продвинутая экономика и снабжение

**Цель:** Добавить стратегический слой управления ресурсами, расширив базовые механики.

1.  **Расходники и обозы:**
    *   Добавление в класс `Army` атрибутов для всех типов расходников: `food`, `ammo`, `supplies`.
    *   Создание юнита `SupplyWagon`. Армии расходуют ресурсы каждый ход.
    *   **Уточнение:** Обозы можно загружать ресурсами в любом дружественном поселении, которое их производит.
2.  **Детализированная экономика фракций:**
    *   Города и деревни получают атрибут `production` (еда, золото и т.д.). **Тип поселения и его специализация определяются при генерации карты.**
    *   Помимо городов и деревень, на карте могут генерироваться другие типы поселений (например, **форпосты, сторожевые башни**).
    *   Фракции могут тратить ресурсы на найм новых юнитов (механика расширяется).
3.  **Истощение (Attrition):**
    *   Если у армии заканчивается еда, она начинает терять юнитов каждый ход.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что ресурсы корректно производятся и тратятся, а истощение правильно работает.
*   **Балансировка:** Настроить скорость потребления ресурсов и их производство, чтобы избежать быстрого коллапса или бесконечного накопления.

**Результат этапа:** Победа зависит не только от тактики, но и от стратегии и логистики.

---

### Этап 12: Продвинутые механики

**Цель:** Добавить оставшиеся системы для полноты игрового опыта.

1.  **Спец. отряды и система мировых действий:**
    *   Реализация уникальных действий для спец. отрядов: `Engineer.build_fort()`, `Spy.sabotage()`.
    *   Создание `WorldActionSystem` — системы, которая управляет длительными, не-боевыми действиями на карте мира.
2.  **Продвинутый ИИ:**
    *   **Система отношений:** ИИ-генералы формируют личные отношения (`"ненависть"`, `"соперничество"`) друг с другом, что влияет на выбор целей.
    *   **Система амбиций:** Реализация долгосрочных стратегических целей для ИИ.
3.  **Система лояльности и предательства:**
    *   Добавление атрибута `loyalty` в профиль ИИ.
    *   Лояльность меняется после боёв, из-за голода или событий. При низкой морали — шанс дезертирства или предательства.
4.  **Герои:**
    *   Реализация класса `Hero` как **уникального, мощного юнита**, который сражается в бою, имеет свои характеристики и может быть убит (в отличие от нематериального генерала).
5.  **Осадные машины:**
    *   Добавление классов для осадных машин: `Catapult`, `BatteringRam` и их интеграция в боевую систему.
6.  **Мораль и дезертирство:**
    *   Добавление атрибута `morale` в класс `Army`.
    *   Мораль меняется после боёв, из-за голода или событий. При низкой морали — шанс дезертирства.
7.  **Случайные события:**
    *   Создание `EventSystem`, которая может генерировать случайные события.

**Сопутствующие задачи:**
*   **Тестирование:** Создать ситуации для проверки работы спец. отрядов, героев, морали, дезертирства и случайных событий.
*   **Интеграция:** Убедиться, что все новые механики гармонично работают друг с другом (например, предательство ИИ из-за низкой лояльности после провальной осады).

**Результат этапа:** Игра становится более глубокой и реиграбельной.

---

### Этап 13: Интерфейс и полировка

**Цель:** Сделать игру удобной и приятной для игрока.

1.  **Главное меню и UI:**
    *   Создание сцен: `MainMenuScene`, `GameScene`, `SettingsScene`.
    *   Реализация сохранения/загрузки игры (сериализация состояния `GameWorld`).
    *   Добавление на игровой экран виджетов календаря и часов.
2.  **Информационные панели:**
    *   Создание UI-элементов для отображения логов, докладов ИИ, внутриигрового справочника (энциклопедии) и каталога генералов с их наследием.
3.  **Визуальная полировка:**
    *   Переход от временной геометрической графики к более сложной и проработанной процедурной отрисовке юнитов, армий и элементов ландшафта.
    *   Добавление процедурных визуальных эффектов для ключевых событий (смена погоды, бои, катаклизмы).
4.  **Балансировка и отладка:**
    *   Интенсивное тестирование, исправление багов, настройка всех числовых параметров.

**Сопутствующие задачи:**
*   **Пользовательское тестирование (Playtesting):** Предоставить прототип для тестирования нескольким людям, чтобы собрать отзывы об удобстве интерфейса и понятности механик.
*   **Оптимизация:** Профилировать код, найти и устранить узкие места в производительности, особенно в рендеринге и логике ИИ.

**Результат этапа:** Полноценный, отполированный продукт.

---

### Этап 14: Контент и расширяемость

**Цель:** Обеспечить долгосрочную поддержку и реиграбельность.

1.  **Сценарии и достижения:**
    *   Создание системы для запуска игры с предопределёнными условиями.
    *   Реализация системы отслеживания и отображения достижений генералов.
2.  **Уникальные локации:**
    *   Добавление в генератор карт возможности создавать уникальные, единственные в своём роде тайлы (например, "Древняя кузница", "Священная роща"), дающие глобальные бонусы фракции, которая их контролирует.
3.  **Поддержка модов:**
    *   Рефакторинг кода для загрузки данных (юниты, ландшафты, правила) из внешних JSON или YAML файлов.
4.  **Наполнение контентом:**
    *   Написание текстов для энциклопедии, докладов, сценариев.

**Сопутствующие задачи:**
*   **Тестирование модов:** Проверить механизм загрузки модов на примере нескольких тестовых модов.
*   **Документация для моддеров:** Написать руководство по созданию модов для игры.

**Результат этапа:** Готовая к релизу игра с возможностью расширения силами сообщества. 