# Технический план разработки (детализированный)
## Проект: "Хроники Вечной Войны"

---

### Введение

Этот документ описывает поэтапный план разработки проекта "Хроники Вечной Войны". Этапы выстроены в логическом порядке, от создания фундаментальных механик к добавлению более сложных систем и контента. Каждый этап содержит детализированные задачи и шаги по контролю качества для обеспечения ясного и последовательного процесса разработки.

---

### Этап 1: Ядро и архитектура

**Цель:** Создать базовую структуру проекта и заложить основу для всех будущих механик.

1.  **Настройка проекта:** `[ВЫПОЛНЕНО]`
    *   Создание структуры папок: `src/` (с подпапками `core`, `ai`, `ui`, `game_objects`), `tests/`.
    *   Инициализация репозитория `git`.
    *   Создание файла `main.py` - точки входа в приложение.
2.  **Движок игры:** `[ВЫПОЛНЕНО]`
    *   В `main.py`: инициализация `Pygame`.
    *   Создание класса `Game` в `src/core/game.py`, отвечающего за главный игровой цикл (main loop).
    *   Реализация обработки базовых событий (выход из игры).
3.  **Управление временем и календарь:** `[ОСНОВА ЗАЛОЖЕНА]`
    *   В классе `Game`: внедрение `pygame.time.Clock` для контроля FPS.
    *   Создание в `Game` переменных-заглушек для паузы и ускорения времени (`paused`, `time_multiplier`).
    *   Создание в `GameWorld` переменной-заглушки для отслеживания времени (`current_time`).
4.  **Базовые классы:** `[ВЫПОЛНЕНО]`
    *   `src/game_objects/unit.py`: `Unit` (атрибуты: `hp`, `attack`, `defense`).
    *   `src/game_objects/army.py`: `Army` (атрибуты: список `units`, `position`).
    *   `src/game_objects/faction.py`: `Faction` (атрибуты: список `armies`, `color`, `name`).
    *   `src/core/world.py`: `GameWorld` (атрибуты: `map_data`, список `factions`, `current_time`).
5.  **Система рендеринга:** `[ВЫПОЛНЕНО]`
    *   В `src/core/renderer.py`: класс `Renderer` с методом `render(world, screen)`, который пока ничего не отрисовывает, но вызывается в главном цикле.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что игровой цикл стабилен, время ускоряется/замедляется и ставится на паузу корректно, а внутриигровой календарь правильно считает дни и сезоны.
*   **Документация:** Написать докстринги для базовых классов (`Game`, `GameWorld`, `Army` и т.д.).

**Результат этапа:** Чёрный экран, работающий игровой цикл, управление временем через консоль/клавиши. В памяти создаются и существуют базовые объекты игры и система календаря.

---

### Этап 2: Мир и карта `[ЗАВЕРШЕН]`

**Цель:** Сделать мир видимым и интерактивным.

1.  **Процедурная генерация карты:** `[ВЫПОЛНЕНО]`
    *   В `src/core/map_generator.py`: функция `generate_map(width, height)`, использующая, например, шум Перлина для создания 2D-массива тайлов.
    *   Определение базовых типов тайлов: `GRASS`, `WATER`, `MOUNTAIN`, `FOREST`.
2.  **Визуализация карты:** `[ВЫПОЛНЕНО]`
    *   В `Renderer`: метод `render_map(map_data, screen)` для отрисовки тайлов.
    *   Отрисовка тайлов цветными прямоугольниками, генерируемыми, в зависимости от типа ландшафта.
3.  **Камера:** `[ВЫПОЛНЕНО]`
    *   В `src/core/camera.py`: класс `Camera` с атрибутами `x`, `y`, `zoom`.
    *   Реализация методов `move(dx, dy)` и `zoom_in/out()`.
    *   Интеграция камеры в `Renderer` для отрисовки только видимой части карты.

**Сопутствующие задачи:**
*   **Тестирование:** `[ВЫПОЛНЕНО]` Проверить, что камера плавно движется и масштабируется, не выходит за границы карты.
*   **Документация:** `[ВЫПОЛНЕНО]` Написать докстринги для класса `Camera`.

**Результат этапа:** Отображается игровая карта, которую можно исследовать с помощью перемещения и масштабирования камеры. Производительность стабильна.

---

### Этап 3: Базовые механики армий и юнитов `[ЗАВЕРШЕН]`

**Цель:** "Оживить" карту, добавив на неё движущиеся объекты.

1.  **Рендеринг армий:** `[ВЫПОЛНЕНО]`
    *   В `Renderer`: метод `render_armies(armies, screen, camera)`, отображающий армии в виде цветных кругов на их координатах.
2.  **Перемещение:** `[ВЫПОЛНЕНО]`
    *   Интеграция библиотеки для поиска пути, например, `pathfinding`. `[ОТЛОЖЕНО]` - реализовано прямолинейное движение.
    *   В классе `Army`: метод `set_destination(x, y)`, который рассчитывает путь и сохраняет его. `[ВЫПОЛНЕНО]`
    *   В главном цикле: обновление позиций армий вдоль рассчитанного пути с учётом `time_multiplier`. `[ВЫПОЛНЕНО]`
3.  **Управление для тестов:** `[ВЫПОЛНЕНО]`
    *   Реализация обработки кликов мыши для выбора армии и задания ей точки назначения.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить корректность работы pathfinding-а на разных ландшафтах, убедиться, что армии следуют приказам и не проходят сквозь непроходимые тайлы. `[ОТЛОЖЕНО]`
*   **Временная графика:** Создать простые иконки или спрайты для армий разных фракций, чтобы их можно было различать.

**Результат этапа:** Реализована возможность кликать по армиям и задавать им цель, после чего они плавно перемещаются по карте к указанной точке.

---

### Этап 4: Базовая боевая система `[ЗАВЕРШЕН]`

**Цель:** Реализовать ключевой элемент игры — столкновение армий.

1.  **Обнаружение столкновений:** `[ВЫПОЛНЕНО]`
    *   В главном цикле: проверка расстояний между армиями враждующих фракций.
    *   При сближении на определённое расстояние — запуск боя.
2.  **Расчёт боя:** `[ВЫПОЛНЕНО]`
    *   **Рефакторинг:** Устаревшая функция `resolve_combat` заменена на класс `Combat`, который управляет пошаговым боем. Бой теперь представляет собой процесс, а не мгновенный расчет.
3.  **Визуализация и логи:** `[ВЫПОЛНЕНО]`
    *   После боя проигравшая армия удаляется из списка фракции.
    *   В консоль выводится структурированный и подробный лог боя по раундам.

**Сопутствующие задачи:**
*   **Тестирование:** Запустить несколько тестовых боев с разными составами армий, проверить корректность расчётов и удаления проигравшего. `[ВЫПОЛНЕНО]`
*   **Документация:** Описать класс `Combat` и формат данных, которые он возвращает. `[ВЫПОЛНЕНО]`

**Результат этапа:** Армии могут сражаться в тактическом, пошаговом режиме. Система боя стала динамической и менее предсказуемой. Появляется первая версия игрового цикла "перемещение -> бой".

---

### Этап 5: Начальный ИИ-генерал [ЗАВЕРШЕН]

**Цель:** Сделать мир автономным, передав управление армиями ИИ.

1.  **Архитектура ИИ:** `[ВЫПОЛНЕНО]`
    *   Создание папки `src/ai/profiles`.
    *   Создание базовых профилей `aggressive_general.json` и `base_knowledge.json`.
    *   Класс `GeneralAI` в `src/ai/general_ai.py` с логикой загрузки своего профиля.
2.  **Простейшая логика:** `[ВЫПОЛНЕНО]`
    *   Внутри `update`: ИИ находит ближайшую вражескую армию и отдает приказ на атаку, основываясь на параметре `aggression` из своего профиля.
    *   **Уточнение:** "Директивы" ИИ (например, атаковать) являются частью его внутренней логики и не приходят извне.
3.  **Интеграция:** `[ВЫПОЛНЕНО]`
    *   Привязка экземпляров `GeneralAI` к каждой армии при ее создании.
    *   В главном цикле: вызов метода `update` для каждого ИИ-генерала.
    *   Отключение ручного управления армиями.
4.  **Концепция этапа:** `[ВЫПОЛНЕНО]`
    *   На данном этапе мир является "закрытой песочницей". Новые юниты и армии **не создаются**. Цель — научить ИИ управлять имеющимися силами.
    *   Боевая система оперирует конкретными юнитами внутри армий-контейнеров. Потери безвозвратны в рамках текущей сессии.

**Сопутствующие задачи:**
*   **Тестирование:** Наблюдать за поведением ИИ в течение длительного времени, убедиться, что он не зависает, не создаёт "пробок" из армий и принимает базовые решения. `[ВЫПОЛНЕНО]`
*   **Рефакторинг:** Отделить логику ИИ от основного игрового цикла, чтобы их можно было развивать независимо. `[ВЫПОЛНЕНО]`

**Результат этапа:** Игра может "играть сама в себя". Армии под управлением ИИ перемещаются по карте и сражаются друг с другом. Тестовое управление от игрока отключено.

---

### Этап 6: Расширение мира и разнообразия

**Цель:** Добавить тактическую глубину в существующие механики.

1.  **Архитектурный рефакторинг: Тайл как контейнер:** `[ВЫПОЛНЕНО]`
    *   **Реализация:** Полная переработка класса `Tile` и связанных систем под архитектуру "Тайл-контейнер". Тайл теперь состоит из `базового ландшафта` (например, `лес`) и `списка объектов` (`Дорога`).
    *   **Обновление генератора карт:** `map_generator.py` теперь генерирует дорожную сеть как отдельный слой объектов поверх базового ландшафта.
    *   **Обновление логики:** Система поиска пути (`pathfinding`) и расчет передвижения теперь динамически учитывают объекты на тайле (дороги).
2.  **Владение территориями и регионы:** `[В ПРОЦЕССЕ]`
    *   **Концепция:** Карта делится на именованные, географически осмысленные регионы (например, "Чернолесье", "Солнечные поля"), которые могут принадлежать фракциям. Это повышает стратегическую глубину, позволяя ИИ и игроку мыслить целями высокого уровня ("захватить регион"), а не отдельными тайлами.
    *   **Фаза 1: Архитектурный фундамент.** `[ВЫПОЛНЕНО]`
        -   Создание класса `Territory`.
        -   Добавление `territory_id` в `Tile`.
        -   Реализация временного генератора, делящего карту на регионы по сетке.
        -   Подготовка `GameWorld` и `Game` для работы с территориями.
    *   **Фаза 2: Механики и визуализация.** `[НЕ НАЧАТО]`
        -   Назначение стартовых владельцев территориям.
        -   Реализация "политического" режима карты с переключением по клавише (V), который будет окрашивать территории в цвета фракций.
    *   **Фаза 3: "Умный" генератор регионов.** `[НЕ НАЧАТО]`
        -   Замена генератора-сетки на алгоритм, который анализирует ландшафт и создает логичные, именованные регионы на основе географии (например, выделяет лесные массивы, горные цепи, долины).
3.  **Усложнение боевой системы:** `[ВЫПОЛНЕНО]`
    *   **Архитектура юнитов:** Проведен полный рефакторинг системы юнитов. Все характеристики и типы юнитов теперь централизованно хранятся в `src/core/unit_config.py`, что устранило жестко закодированные значения.
    *   **Боевая формула:** Формула расчета урона заменена на процентную модель для устранения ситуаций с "непробиваемой" защитой.
    *   **Система контр-юнитов:** Расчет боя теперь учитывает бонусы от системы контр-юнитов.
4.  **Архитектура боя: Система "Боевых стоек" (Stances):** `[ВЫПОЛНЕНО]`
    *   **Реализация:** Внедрение в класс `Army` атрибута `stance`, описывающего текущее состояние армии (`IDLE` — стоит на месте, `MOVING` — движется). `GeneralAI` будет управлять этим состоянием.
    *   **Определение типа боя:** Логика столкновения будет анализировать стойки обеих армий:
        *   `MOVING` vs `MOVING`: **Встречный бой.** Происходит на "нейтральной" территории между клетками, бонусы ландшафта **не учитываются**.
        *   `MOVING` vs `IDLE`: **Атака на позицию.** Армия в стойке `IDLE` считается обороняющейся и **получает все бонусы** от ландшафта своей клетки.
    *   **Расширяемость:** Эта архитектура является фундаментом для будущих механик. В последующих этапах система будет расширена новыми тактическими стойками.
5.  **Интеллектуальное перемещение армий (Архитектура "Генерал-Штурман"):** `[НЕ НАЧАТО]`
    *   **Концепция:** Полный перенос интеллектуальной нагрузки по планированию маршрута с алгоритма `pathfinder` на `GeneralAI`. Генерал не "спрашивает дорогу", а сам "прокладывает маршрут", используя `pathfinder` лишь как калькулятор для оценки отдельных участков.
    *   **Реализация:**
        - В `GeneralAI` создается внутренний модуль `RoutePlanner` для навигации.
        - `RoutePlanner` определяет несколько ключевых стратегических узлов на карте (центры регионов, мосты, перевалы).
        - `GeneralAI` анализирует предложенные маршруты через узлы, оценивая их по длине и рискам (на основе своей `knowledge_map` и черт характера).
        - Реализуется механика динамического перепланирования маршрута при изменении обстановки.
    *   **Будущее развитие:** Текущая оценка рисков будет в дальнейшем развита в полноценную вероятностную модель, учитывающую множество факторов (погода, состав армии врага и т.д.).
6.  **Визуальное улучшение дорог:**`[ВЫПОЛНЕНО]`
    *   Модификация `Renderer` для "умной" отрисовки дорог. Рендерер должен анализировать соседние тайлы, чтобы рисовать правильные сегменты дороги (прямые, повороты, перекрестки), создавая единое дорожное полотно.

**Сопутствующие задачи:**
*   **Тестирование:** Провести тесты боевой системы с учётом всех новых юнитов и ландшафтов, проверить все бонусы и штрафы. Проверить корректность работы pathfinding-а.
*   **Балансировка:** Сделать первую грубую настройку характеристик юнитов, чтобы не было явных имбалансных стратегий.

**Результат этапа:** Бои становятся более тактическими. Победа зависит от правильного использования местности и состава армии. Армии перемещаются по карте осмысленно.

---

### Этап 7: Базовое производство и пополнение

**Цель:** Создать замкнутый игровой цикл, в котором фракции могут восстанавливать потери и создавать новые армии, делая мир динамичным.

1.  **Экономика-заглушка:**
    *   Добавление городским территориям свойства генерировать условные "очки производства" каждый игровой день.
    *   Добавление в класс `Faction` атрибута для хранения накопленных очков.
2.  **Механика найма:**
    *   Реализация в классе `Faction` метода `recruit_units`.
    *   **Уточнение:** Разные типы юнитов имеют **разную стоимость** в очках производства.
3.  **Логика ИИ для пополнения:**
    *   В `GeneralAI`: добавление простейшей логики. Если армия понесла потери, она получает команду двигаться к ближайшему дружественному городу для пополнения.
    *   **Уточнение:** ИИ стремится **восстановить свой первоначальный состав армии**, нанимая тех юнитов, которых он потерял.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что фракции корректно накапливают ресурсы и нанимают юнитов, а ИИ-генералы правильно принимают решение отступить для пополнения.
*   **Балансировка:** Настроить стоимость юнитов и скорость генерации очков, чтобы мир не стагнировал и не был переполнен армиями.

**Результат этапа:** Игровой мир становится живым. Армии не только сражаются, но и отступают, пополняются и формируются заново, что создает основу для долгосрочной стратегической игры.

---

### Этап 8: Обучение и принятие решений ИИ

**Цель:** Сделать ИИ "умным" и обучаемым.

1.  **База знаний и история:**
    *   В `GeneralAI`: расширение `knowledge_base` (словарь для хранения фактов) и `decision_history`.
    *   **Событийная память:** После боя ИИ запоминает, кто его победил и при каких обстоятельствах, формируя "обиды".
2.  **Система обучения:**
    *   Создание системы весов для тактик (`tactical_matrix` в JSON-профиле).
    *   После боя — вызов функции `learn_from_battle`, которая корректирует веса в профиле и **сохраняет JSON-файл на диск**.
3.  **Контекстное принятие решений:**
    *   `update` ИИ теперь анализирует не только врагов, но и ландшафт, состав армии, свои черты характера (`Traits`) и выбирает тактику с наивысшим весом для текущей ситуации.
    *   Реализация системы **качественных черт характера** (`"Храбрец"`, `"Трус"`), влияющих на выбор тактик.
4.  **Продвинутая оценка рисков (Фаза 2 "Генерала-Штурмана"):** `[НЕ НАЧАТО]`
    *   **Концепция:** Развитие системы оценки рисков из Этапа 6 в полноценную вероятностную модель.
    *   **Реализация:** `RoutePlanner` будет не просто избегать известных угроз, а рассчитывать вероятность возникновения негативных событий (засада, истощение, плохая погода) для каждого сегмента пути.
    *   **Факторы:** Модель будет учитывать тип местности, время суток, время года, данные разведки (или их отсутствие), личность вражеского генерала и историю прошлых событий в этом регионе.
    *   **Интеграция с обучением:** ИИ будет корректировать веса в своей модели рисков на основе исходов своих походов, обучаясь на ошибках.

**Сопутствующие задачи:**
*   **Тестирование:** Создать тестовые сценарии, чтобы проверить, меняется ли поведение ИИ после серии побед/поражений.
*   **Логирование:** Улучшить логирование, чтобы видеть, *почему* ИИ принял то или иное решение.

**Результат этапа:** ИИ-генералы начинают вести себя по-разному, адаптироваться к результатам прошлых боёв и использовать доступные им механики пополнения.

---

### Этап 9: Система климата, сезонов и динамической погоды

**Цель:** Внедрить полноценную систему климата, смены сезонов и динамической погоды, чтобы создать реалистичную среду для стратегического планирования и дальнейшей интеграции с ИИ.

1.  **Климатические зоны:**
    *   Генерация климатических зон на карте (например, умеренный, континентальный, болотистый, горный, пустынный и т.д.).
    *   Привязка типов местности к климату.
2.  **Сезоны и календарь:**
    *   Реализация смены сезонов (весна, лето, осень, зима) с влиянием на ландшафт и погодные события.
    *   Продвинутый календарь с отслеживанием текущей даты, времени года и длительности сезонов.
3.  **WeatherSystem:**
    *   Создание системы динамической погоды: генерация погодных событий (дождь, снег, жара, туман, бури, засуха и т.д.) с учётом климата и сезона.
    *   Влияние погоды на карту, армии, снабжение, мораль и боеспособность.
    *   Возможность появления катастроф (наводнения, засуха, пожары и т.д.).
4.  **Взаимодействие с миром:**
    *   Погодные эффекты отображаются на карте и влияют на игровой процесс.
    *   Подготовка интерфейса для отображения текущей погоды и прогноза на ближайшие дни.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить корректность генерации климата, смены сезонов и погодных событий, влияние на юнитов и карту.
*   **Документация:** Описать архитектуру WeatherSystem, климатических зон и календаря.

**Результат этапа:** В игре появляется реалистичная система климата, сезонов и динамической погоды, создающая основу для стратегического планирования и дальнейшей работы с прогнозами и ИИ.

---

### Этап 10: Работа с прогнозами погоды и доверием к информации

**Цель:** Научить генералов учитывать прогнозы погоды и степень доверия к информации при планировании маршрутов и принятии решений.

1.  **Структура хранения прогнозов:**
    *   Реализовать структуру для хранения прогнозов погоды с указанием источника (игрок, опыт, разведка, местные жители) и confidence (доверия).
2.  **Интеграция разных источников:**
    *   Обработка информации о погоде от разных источников (игрок, опыт, разведка, местные).
3.  **Анализ достоверности:**
    *   Внедрить механизм анализа достоверности информации (сравнение с климатом региона, временем года, опытом генерала).
4.  **Влияние доверия на планирование:**
    *   Встроить влияние доверия к информации на выбор маршрута в RoutePlanner (чем выше доверие — тем сильнее влияние на маршрут, при низком доверии — запасные планы или игнорирование).
5.  **Обновление доверия:**
    *   Реализовать обновление доверия к источнику после наступления/отсутствия события (например, если прогноз не сбылся — доверие к источнику падает).
6.  **Обновление базы знаний:**
    *   Обеспечить обновление knowledge_base генерала на основе исхода событий и новых данных.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что генералы корректно реагируют на прогнозы погоды разной достоверности, строят гибкие маршруты и обновляют доверие к источникам.
*   **Документация:** Описать структуру хранения прогнозов и алгоритмы обновления доверия.

**Результат этапа:** Генералы начинают учитывать прогнозы погоды и степень доверия к информации, строят более реалистичные и адаптивные маршруты, учатся на ошибках и корректируют стратегию в будущем.

---

### Этап 11: Продвинутое тактическое управление и бой

**Цель:** Создать двухуровневую тактическую систему: управление отрядами на глобальной карте и симуляция боев на тактической мини-карте.

1.  **Архитектура отрядов (Глобальная карта):**
    *   Создание класса `Detachment` (Отряд), который становится основной движущейся единицей.
    *   Изменение класса `Army`, который теперь выступает как организационная структура, управляющая своими отрядами.
    *   **Иерархия командования:** Решения о найме юнитов принимает только `GeneralAI` на уровне `Army`. Отряд (`Detachment`) **не может** сам нанимать юнитов. Генерал может приказать отряду транспортировать уже нанятых юнитов из города в основную армию.

2.  **Продвинутая система боевых стоек (Глобальная карта):**
    *   **Перенос на уровень отряда:** Атрибут `stance` переносится с `Army` на `Detachment`, позволяя генералу отдавать приказы отдельным тактическим группам.
    *   **Расширение тактических возможностей:** Внедрение новых стоек (`CHARGE`, `SKIRMISH`, `ESCORT`, `SCOUT`, `CAMPING` и т.д.), работающих в комбинации.
    *   **Комбинированные тактики:** `GeneralAI` будет обучаться создавать эффективные тактические группы с разными, но взаимодополняющими стойками (например, `Обоз(SUPPLY) + Конница(ESCORT) + Разведка(SCOUT)`), что станет основой для сложных маневров на глобальной карте.

3.  **Архитектура "Погружения в тайл" (Начало боя):**
    *   При столкновении отрядов генерируется **зональная мини-карта**, структура которой зависит от глобального тайла.
    *   Класс `Combat` заменяется на `Battlefield`, который управляет состоянием тактической карты.

4.  **Связь двух уровней (Ключевая механика):**
    *   `GeneralAI` использует информацию о своих отрядах и их **стойках** для **автоматической расстановки сил по зонам** на мини-карте перед боем. (Например, отряд в стойке `SCOUT` занимает позицию в авангарде, а `AMBUSH` дает преимущество в лесу).

5.  **Зональная симуляция (Тактический бой):**
    *   Реализация правил боя по зонам: фронт атакует фронт, фланги могут атаковать центр и тыл противника, стрелки ведут огонь из тыловой зоны.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что ИИ корректно разделяет армии на отряды, использует стойки и что это влияет на расстановку в бою.
*   **Визуализация:** Создать схематичное отображение отрядов на глобальной карте и зональной расстановки на тактической.

**Результат этапа:** Исход боя зависит не только от типа местности, но и от тактической подготовки на глобальной карте — разделения сил и правильного использования стоек.

---

### Этап 12: Механики игрока-"бога"

**Цель:** Реализовать основной геймплей со стороны игрока.

1.  **Погода и катастрофы:**
    *   Создание системы погоды (`WeatherSystem`), которая меняет глобальные модификаторы.
    *   Реализация UI-кнопок для игрока, чтобы вызывать дождь, туман и т.д.
2.  **NLP-модуль:**
    *   Интеграция `spaCy`. Создание функции `parse_player_message(text)`, которая извлекает сущности.
    *   Метод `inject_information` у `GeneralAI` для добавления этих фактов в `knowledge_base`.
    *   **Система "обиды на игрока":** Если советы игрока приводят к плохим результатам, ИИ может начать их игнорировать.
3.  **Интерфейс взаимодействия:**
    *   Создание текстового поля для ввода сообщений, UI для допроса генерала (вызывает его метод `generate_report`).
    *   Реализация обратной связи, показывающей, как ИИ интерпретировал команду игрока.
4.  **Отладочный UI:**
    *   Создание простого технического UI для разработчика, который наглядно показывает работу NLP-модуля: `исходный текст -> извлеченные сущности -> факт в базе знаний ИИ`. Это необходимо для эффективной отладки.

**Сопутствующие задачи:**
*   **Тестирование:** Протестировать все способы влияния игрока: погода, катастрофы, ввод текста. Проверить, что ИИ корректно реагирует на полученную информацию с помощью отладочного UI.
*   **Документация:** Описать API для NLP-модуля и системы событий, чтобы их было легко расширять.

**Результат этапа:** Реализована возможность для игрока активно влиять на мир и поведение ИИ.

---

### Этап 13: Продвинутая экономика и снабжение

**Цель:** Добавить стратегический слой управления ресурсами, расширив базовые механики.

1.  **Расходники и обозы:**
    *   Добавление в класс `Army` атрибутов для всех типов расходников: `food`, `ammo`, `supplies`.
    *   Создание юнита `SupplyWagon`. Армии расходуют ресурсы каждый ход.
    *   **Уточнение:** Обозы можно загружать ресурсами в любом дружественном поселении, которое их производит.
2.  **Детализированная экономика фракций:**
    *   Города и деревни получают атрибут `production` (еда, золото и т.д.). **Тип поселения и его специализация определяются при генерации карты.**
    *   Помимо городов и деревень, на карте могут генерироваться другие типы поселений (например, **форпосты, сторожевые башни**).
    *   Фракции могут тратить ресурсы на найм новых юнитов (механика расширяется).
3.  **Тактический бой — Фаза 2 (Динамическая карта):**
    *   **Мини-карта становится сеточной:** Зональная карта заменяется на полноценную сеточную карту (например, 40x40), по которой отряды могут перемещаться.
    *   **Приказы в бою:** `GeneralAI` получает возможность отдавать приказы отрядам прямо в ходе боя (`Атаковать цель`, `Удерживать позицию`, `Отступить`).
    *   **Внедрение морали и усталости:** Отряды получают новые параметры, влияющие на их боеспособность в динамике.
    *   **Интеграция способностей:** Герои и спец. юниты получают активные способности, которые ИИ может применять в бою.

**Сопутствующие задачи:**
*   **Тестирование:** Проверить, что ИИ осмысленно маневрирует отрядами и использует способности.
*   **Балансировка:** Настроить стоимость юнитов и скорость генерации очков, чтобы избежать быстрого коллапса или бесконечного накопления.

**Результат этапа:** Победа зависит не только от тактики, но и от стратегии и логистики.

---

### Этап 14: Продвинутые механики

**Цель:** Добавить оставшиеся системы для полноты игрового опыта.

1.  **Тактический бой — Фаза 3 (Реалистичная симуляция):**
    *   **Микро-уровень:** Вводится моделирование отдельных юнитов внутри отрядов (позиция, состояние).
    *   **Туман войны:** На тактической карте появляется система обзора и скрытности.
    *   **Интерактивное окружение:** ИИ получает возможность использовать окружение — поджигать лес, разрушать мосты, строить временные укрепления.
    *   **Связь с глобальной картой:** Итоги боя (например, выжженная земля) отражаются на состоянии глобального тайла после сражения.
2.  **Спец. отряды и система мировых действий:**
    *   Реализация уникальных действий для спец. отрядов: `Engineer.build_fort()`, `Engineer.build_road()`, `Engineer.build_bridge()`, `Spy.sabotage()`.
    *   Создание `WorldActionSystem` — системы, которая управляет длительными, не-боевыми действиями на карте мира.
3.  **Продвинутый ИИ:**
    *   **Система отношений:** ИИ-генералы формируют личные отношения (`"ненависть"`, `"соперничество"`) друг с другом, что влияет на выбор целей.
    *   **Система амбиций:** Реализация долгосрочных стратегических целей для ИИ.
4.  **Система лояльности и предательства:**
    *   Добавление атрибута `loyalty` в профиль ИИ.
    *   Лояльность меняется после боёв, из-за голода или событий. При низкой морали — шанс дезертирства или предательства.
5.  **Герои:**
    *   Реализация класса `Hero` как **уникального, мощного юнита**, который сражается в бою, имеет свои характеристики и может быть убит (в отличие от нематериального генерала).
6.  **Осадные машины:**
    *   Добавление классов для осадных машин: `Catapult`, `BatteringRam` и их интеграция в боевую систему.
7.  **Мораль и дезертирство:**
    *   Добавление атрибута `morale` в класс `Army`.
    *   Мораль меняется после боёв, из-за голода или событий. При низкой морали — шанс дезертирства.
8.  **Случайные события:**
    *   Создание `EventSystem`, которая может генерировать случайные события.

**Сопутствующие задачи:**
*   **Тестирование:** Создать ситуации для проверки работы спец. отрядов, героев, морали, дезертирства и случайных событий.
*   **Интеграция:** Убедиться, что все новые механики гармонично работают друг с другом (например, предательство ИИ из-за низкой лояльности после провальной осады).

**Результат этапа:** Игра становится более глубокой и реиграбельной.

---

### Этап 15: Интерфейс и полировка

**Цель:** Сделать игру удобной и приятной для игрока.

1.  **Главное меню и UI:**
    *   Создание сцен: `MainMenuScene`, `GameScene`, `SettingsScene`.
    *   Реализация сохранения/загрузки игры (сериализация состояния `GameWorld`).
    *   Добавление на игровой экран виджетов календаря и часов.
2.  **Информационные панели:**
    *   Создание UI-элементов для отображения логов, докладов ИИ, внутриигрового справочника (энциклопедии) и каталога генералов с их наследием.
3.  **Визуальная полировка:**
    *   Переход от временной геометрической графики к более сложной и проработанной процедурной отрисовке юнитов, армий и элементов ландшафта.
    *   Добавление процедурных визуальных эффектов для ключевых событий (смена погоды, бои, катаклизмы).
4.  **Балансировка и отладка:**
    *   Интенсивное тестирование, исправление багов, настройка всех числовых параметров.

**Сопутствующие задачи:**
*   **Пользовательское тестирование (Playtesting):** Предоставить прототип для тестирования нескольким людям, чтобы собрать отзывы об удобстве интерфейса и понятности механик.
*   **Оптимизация:** Профилировать код, найти и устранить узкие места в производительности, особенно в рендеринге и логике ИИ.

**Результат этапа:** Полноценный, отполированный продукт.

---

### Этап 16: Контент и расширяемость

**Цель:** Обеспечить долгосрочную поддержку и реиграбельность.

1.  **Сценарии и достижения:**
    *   Создание системы для запуска игры с предопределёнными условиями.
    *   Реализация системы отслеживания и отображения достижений генералов.
2.  **Уникальные локации:**
    *   Добавление в генератор карт возможности создавать уникальные, единственные в своём роде тайлы (например, "Древняя кузница", "Священная роща"), дающие глобальные бонусы фракции, которая их контролирует.
3.  **Поддержка модов:**
    *   Рефакторинг кода для загрузки данных (юниты, ландшафты, правила) из внешних JSON или YAML файлов.
4.  **Наполнение контентом:**
    *   Написание текстов для энциклопедии, докладов, сценариев.

**Сопутствующие задачи:**
*   **Тестирование модов:** Проверить механизм загрузки модов на примере нескольких тестовых модов.
*   **Документация для моддеров:** Написать руководство по созданию модов для игры.

**Результат этапа:** Готовая к релизу игра с возможностью расширения силами сообщества. 